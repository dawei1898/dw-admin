# DW Admin 双重云存储支持设计方案

## 项目概述

DW Admin 当前使用阿里云OSS作为文件存储服务。本方案旨在扩展支持腾讯云COS对象存储，通过工厂模式实现两种云存储服务的灵活切换。

## 设计目标

1. **向后兼容**: 保持现有阿里云OSS功能完全不变
2. **配置驱动**: 通过配置文件选择使用的云存储服务商
3. **统一接口**: 对外提供统一的文件存储服务接口
4. **易于扩展**: 为将来支持更多云存储服务预留扩展空间

## 架构设计

### 1. 核心接口设计

#### FileStorageService.java
```java
/**
 * 统一文件存储服务接口
 */
public interface FileStorageService {
    
    /**
     * 上传文件
     * @param multipartFile 文件信息
     * @return 文件存储信息
     */
    FileInfo uploadFile(MultipartFile multipartFile);
    
    /**
     * 下载文件
     * @param fileKey 文件路径
     */
    void downloadFile(String fileKey);
    
    /**
     * 获取预签名URL
     * @param fileKey 文件路径
     * @return 文件预签名URL
     */
    String getPresignedUrl(String fileKey);
    
    /**
     * 删除文件
     * @param fileKey 文件路径
     * @return 是否删除成功
     */
    boolean deleteFile(String fileKey);
}
```

### 2. 具体实现类

#### OssService.java (重构)
- **现状**: 当前阿里云OSS实现类
- **改进**: 实现FileStorageService接口
- **保持**: 所有现有功能保持不变
- **增强**: 添加统一的接口实现

#### CosService.java (新建)
- **功能**: 腾讯云COS实现类
- **实现**: FileStorageService接口
- **依赖**: com.qcloud:cos_api:5.6.227
- **API**: 对应COS SDK的所有必要操作

### 3. 工厂模式核心

#### FileStorageFactory.java
```java
@Component
public class FileStorageFactory {
    
    @Resource
    private StorageProperties storageProperties;
    
    @Resource
    private OssService ossService;
    
    @Resource
    private CosService cosService;
    
    /**
     * 根据配置获取对应的存储服务实例
     * @return 文件存储服务实例
     */
    public FileStorageService getStorageService() {
        String provider = storageProperties.getProvider();
        switch (provider) {
            case "aliyun":
                log.info("使用阿里云OSS文件存储服务");
                return ossService;
            case "tencent":
                log.info("使用腾讯云COS文件存储服务");
                return cosService;
            default:
                throw new BizException("不支持的存储提供商: " + provider + 
                    ", 支持的提供商: aliyun, tencent");
        }
    }
}
```

### 4. 配置结构设计

#### StorageProperties.java
```java
@Configuration
@ConfigurationProperties(prefix = "dwa.file.storage")
public class StorageProperties {
    
    /**
     * 存储提供商: aliyun, tencent
     */
    private String provider;
    
    /**
     * 阿里云OSS配置
     */
    private OssConfig oss;
    
    /**
     * 腾讯云COS配置
     */
    private CosConfig cos;
    
    @Data
    public static class OssConfig {
        private String accessKey;
        private String secretKey;
        private String endpoint;
        private String bucket;
        private String prefixPath;
        private Long urlExpires;
    }
    
    @Data
    public static class CosConfig {
        private String secretId;
        private String secretKey;
        private String region;
        private String bucket;
        private String prefixPath;
        private Long urlExpires;
    }
}
```

## 实施方案

### 第一阶段: 核心基础设施 (1-2天)

#### 1.1 创建统一接口
- 创建 `FileStorageService` 接口
- 定义标准方法签名
- 添加必要文档注释

#### 1.2 重构现有服务
- 修改 `OssService` 实现 `FileStorageService` 接口
- 确保现有功能完全兼容
- 添加接口实现方法

#### 1.3 添加腾讯云依赖
```xml
<!-- 腾讯云COS SDK -->
<dependency>
    <groupId>com.qcloud</groupId>
    <artifactId>cos_api</artifactId>
    <version>5.6.227</version>
</dependency>
```

### 第二阶段: 腾讯云实现 (2-3天)

#### 2.1 创建COS服务类
- 新建 `CosService` 类
- 实现 `FileStorageService` 接口
- 实现文件上传、下载、删除、预签名URL方法

#### 2.2 COS核心方法实现
```java
@Override
public FileInfo uploadFile(MultipartFile multipartFile) {
    // COS客户端初始化
    COSClient cosClient = new COSClient(credentials, clientConfig);
    
    // 构建COS对象键
    String cosKey = cosProperties.getPrefixPath() + 
                   fileId + "/" + originalFilename;
    
    // 上传文件
    PutObjectRequest putObjectRequest = new PutObjectRequest(
        cosProperties.getBucket(), cosKey, inputStream);
    
    // 返回文件信息
    return FileInfo.builder()
        .id(fileId)
        .name(originalFilename)
        .size(size)
        .type(contentType)
        .path(cosKey)
        .url(generateUrl(cosKey))
        .build();
}
```

### 第三阶段: 配置与工厂 (1天)

#### 3.1 创建统一配置类
- 创建 `StorageProperties` 配置类
- 支持两种云存储配置
- 添加配置验证逻辑

#### 3.2 实现工厂模式
- 创建 `FileStorageFactory` 工厂类
- 根据配置返回对应服务实例
- 添加错误处理和日志记录

#### 3.3 更新配置结构
```yaml
dwa:
  file:
    storage:
      # 存储提供商: aliyun (阿里云), tencent (腾讯云)
      provider: aliyun
      
      # 阿里云OSS配置
      oss:
        access-key: your_aliyun_access_key
        secret-key: your_aliyun_secret_key
        endpoint: your_oss_endpoint
        bucket: your_oss_bucket
        prefix-path: your_prefix_path/
        url-expires: 604800  # 7天
        
      # 腾讯云COS配置
      cos:
        secret-id: your_tencent_secret_id
        secret-key: your_tencent_secret_key
        region: ap-beijing  # COS区域代码
        bucket: your_cos_bucket
        prefix-path: your_prefix_path/
        url-expires: 604800  # 7天
```

### 第四阶段: 集成适配 (1天)

#### 4.1 修改控制器注入
```java
@RestController
@RequestMapping("/file")
public class FileController {
    
    @Resource
    private FileStorageFactory storageFactory;
    
    @PostMapping("/upload")
    public Response<FileInfo> uploadFile(@RequestParam MultipartFile file) {
        FileStorageService storageService = storageFactory.getStorageService();
        FileInfo fileInfo = storageService.uploadFile(file);
        return Response.success(fileInfo);
    }
}
```

#### 4.2 配置验证
- 添加启动时配置验证
- 确保必需配置项完整
- 提供清晰的错误提示

### 第五阶段: 测试验证 (1-2天)

#### 5.1 功能测试
- 阿里云OSS全功能测试
- 腾讯云COS全功能测试
- 配置切换功能测试

#### 5.2 集成测试
- 文件上传功能验证
- 文件下载功能验证
- 文件删除功能验证
- 预签名URL功能验证

#### 5.3 性能测试
- 两种服务的上传性能对比
- 稳定性测试
- 并发测试

## 配置指南

### 开发环境配置示例

#### 使用阿里云OSS
```yaml
dwa:
  file:
    storage:
      provider: aliyun
      oss:
        access-key: ${ALIYUN_ACCESS_KEY:xxxxxx}
        secret-key: ${ALIYUN_SECRET_KEY:xxxxxx}
        endpoint: ${ALIYUN_ENDPOINT:xxxxxx.aliyuncs.com}
        bucket: ${ALIYUN_BUCKET:xxxxxx-oss-bucket}
        prefix-path: ${ALIYUN_PREFIX:dwa/}
        url-expires: 604800
```

#### 使用腾讯云COS
```yaml
dwa:
  file:
    storage:
      provider: tencent
      cos:
        secret-id: ${TENCENT_SECRET_ID:xxxxxx}
        secret-key: ${TENCENT_SECRET_KEY:xxxxxx}
        region: ${TENCENT_REGION:ap-beijing}
        bucket: ${TENCENT_BUCKET:xxxxxx-oss-bucket}
        prefix-path: ${TENCENT_PREFIX:dwa/}
        url-expires: 604800
```

### 生产环境建议

1. **使用环境变量**: 敏感信息通过环境变量配置
2. **独立配置**: 不同环境使用不同的配置文件
3. **配置验证**: 启动时验证配置完整性
4. **日志监控**: 记录存储服务选择和切换

## API文档

### 统一接口方法

#### 1. 文件上传
```http
POST /file/upload
Content-Type: multipart/form-data

参数: file (文件)
响应: 
{
    "code": 200,
    "msg": "success", 
    "data": {
        "id": 123456,
        "name": "example.jpg",
        "type": "image/jpeg",
        "size": 1024000,
        "path": "dwa/123456/example.jpg",
        "url": "https://bucket.endpoint/path"
    }
}
```

#### 2. 文件下载
```http
GET /file/download/{fileKey}
响应: 文件流下载
```

#### 3. 获取预签名URL
```http
GET /file/presigned/{fileKey}
响应:
{
    "code": 200,
    "msg": "success",
    "data": "https://bucket.endpoint/path?expiry=..."
}
```

#### 4. 删除文件
```http
DELETE /file/{fileKey}
响应:
{
    "code": 200,
    "msg": "success",
    "data": true
}
```

## 优势与收益

### 技术优势
1. **灵活切换**: 随时切换云存储服务商，无需代码修改
2. **统一接口**: 对外提供一致的服务接口
3. **易于维护**: 工厂模式便于管理和扩展
4. **配置驱动**: 通过配置文件控制行为

### 业务收益
1. **成本优化**: 可根据价格选择合适的云存储服务
2. **风险分散**: 避免单一云服务商依赖
3. **地域选择**: 根据用户地域选择最优存储节点
4. **容灾备份**: 可实现多云备份策略

### 开发优势
1. **向后兼容**: 现有功能完全不受影响
2. **测试友好**: 便于本地开发和测试
3. **扩展性强**: 为支持更多云存储预留扩展点
4. **标准化**: 统一的服务规范

## 风险评估与应对

### 技术风险
1. **接口兼容性**: 确保不同云服务的API接口一致性
   - **应对**: 详细测试所有接口方法
2. **配置复杂性**: 配置项增多可能增加配置复杂度
   - **应对**: 提供清晰的配置示例和文档
3. **性能差异**: 不同云服务的性能可能有差异
   - **应对**: 进行性能测试和对比

### 运维风险
1. **配置错误**: 错误的配置可能导致服务不可用
   - **应对**: 添加配置验证和错误提示
2. **权限管理**: 需要管理两套云服务的访问凭证
   - **应对**: 统一使用环境变量管理敏感信息

## 扩展规划

### 近期扩展 (v1.1)
- 支持华为云OBS对象存储
- 支持AWS S3对象存储
- 添加存储用量统计功能

### 中期扩展 (v1.2)
- 支持本地文件存储备选方案
- 添加文件存储监控和告警
- 实现文件存储策略自动切换

### 长期扩展 (v2.0)
- 支持多云存储策略 (主备、主主)
- 实现智能存储路径选择
- 添加成本优化建议功能

## 总结

本设计方案通过工厂模式实现了阿里云OSS和腾讯云COS的统一管理，既保证了现有功能的稳定性，又为用户提供了灵活的选择空间。方案具有良好的扩展性，便于后续支持更多的云存储服务。

通过配置驱动的设计，用户可以轻松在不同云存储服务商之间切换，满足不同的业务需求和成本考虑。同时，统一的服务接口确保了代码的一致性和可维护性。

---

**文档版本**: v1.0  
**创建日期**: 2025-11-17  
**最后更新**: 2025-11-17  
**作者**: DW Admin开发团队